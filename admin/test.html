<!DOCTYPE html>
<html>
<head>
  <title>Element Store — UI Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a2e; color: #e0e0e0; overflow: hidden; height: 100vh; }

    /* ─── Layout ─── */
    .app { display: flex; flex-direction: column; height: 100vh; }

    .toolbar {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; background: #16213e; border-bottom: 1px solid #0f3460;
      flex-shrink: 0; flex-wrap: wrap;
    }
    .toolbar h1 { font-size: 15px; color: #e94560; margin-right: 12px; font-weight: 600; }
    .toolbar .sep { width: 1px; height: 24px; background: #0f3460; margin: 0 4px; }

    .toolbar button {
      background: #0f3460; color: #e0e0e0; border: 1px solid #1a4080;
      padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;
      transition: background 0.15s;
    }
    .toolbar button:hover { background: #1a4080; }
    .toolbar .btn-dialog { border-color: #e94560; color: #e94560; }
    .toolbar .btn-dialog:hover { background: #e94560; color: #fff; }
    .toolbar .btn-button { border-color: #0fb; color: #0fb; }
    .toolbar .btn-button:hover { background: #0fb; color: #1a1a2e; }
    .toolbar .btn-save { border-color: #4caf50; color: #4caf50; }
    .toolbar .btn-save:hover { background: #4caf50; color: #fff; }
    .toolbar .btn-arrange { border-color: #f0c040; color: #f0c040; }
    .toolbar .btn-arrange:hover { background: #f0c040; color: #1a1a2e; }
    .toolbar .btn-load { border-color: #2196f3; color: #2196f3; }
    .toolbar .btn-load:hover { background: #2196f3; color: #fff; }
    .toolbar .btn-ws { border-color: #e040fb; color: #e040fb; }
    .toolbar .btn-ws:hover { background: #e040fb; color: #fff; }
    .toolbar .btn-ws.connected { background: #e040fb; color: #fff; }
    .toolbar .btn-inject { border-color: #ff9800; color: #ff9800; }
    .toolbar .btn-inject:hover { background: #ff9800; color: #1a1a2e; }
    .toolbar .btn-clear { margin-left: auto; border-color: #666; color: #888; font-size: 11px; }
    .toolbar .btn-clear:hover { background: #444; color: #ccc; }

    .main { display: flex; flex: 1; overflow: hidden; }

    /* ─── Workspace ─── */
    .workspace {
      flex: 1; position: relative; overflow: hidden;
      background:
        radial-gradient(circle at 50% 50%, #1e2745 0%, #1a1a2e 70%),
        repeating-linear-gradient(0deg, transparent, transparent 29px, #ffffff06 29px, #ffffff06 30px),
        repeating-linear-gradient(90deg, transparent, transparent 29px, #ffffff06 29px, #ffffff06 30px);
    }
    .workspace .hint {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #ffffff20; font-size: 22px; pointer-events: none; user-select: none;
    }

    /* ─── Properties Panel ─── */
    .panel {
      width: 280px; background: #16213e; border-left: 1px solid #0f3460;
      overflow-y: auto; flex-shrink: 0;
    }
    .panel-header {
      padding: 10px 14px; background: #0f3460; font-size: 13px; font-weight: 600;
      color: #e94560; border-bottom: 1px solid #1a4080;
    }
    .panel-empty {
      padding: 20px 14px; color: #ffffff40; font-size: 13px; text-align: center;
    }
    .panel-section { padding: 10px 14px; border-bottom: 1px solid #0f346040; }
    .panel-section h3 {
      font-size: 11px; text-transform: uppercase; color: #e94560; margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .prop-row { display: flex; align-items: center; margin-bottom: 6px; gap: 6px; }
    .prop-label { width: 80px; font-size: 12px; color: #8899aa; flex-shrink: 0; }
    .prop-value {
      flex: 1; background: #1a1a2e; border: 1px solid #0f3460; color: #e0e0e0;
      padding: 4px 8px; border-radius: 3px; font-size: 12px; font-family: monospace; outline: none;
    }
    .prop-value:focus { border-color: #e94560; }
    .prop-readonly { color: #666; font-size: 12px; font-family: monospace; }
    .prop-dirty { color: #f0c040; }

    /* ─── Dialog ─── */
    .ui-dialog {
      position: absolute; min-width: 160px; min-height: 100px;
      background: #1e2745; border: 1px solid #0f3460; border-radius: 6px;
      box-shadow: 0 4px 20px #00000060;
    }
    .ui-dialog.selected { border-color: #e94560; box-shadow: 0 0 0 2px #e9456040, 0 4px 20px #00000060; }
    .ui-dialog .dialog-titlebar {
      display: flex; align-items: center; padding: 6px 10px;
      background: #0f3460; border-radius: 5px 5px 0 0; cursor: move;
      user-select: none; font-size: 13px; font-weight: 600; color: #e0e0e0;
    }
    .ui-dialog .dialog-titlebar .dots { display: flex; gap: 4px; margin-right: 8px; }
    .ui-dialog .dialog-titlebar .dot { width: 8px; height: 8px; border-radius: 50%; }
    .ui-dialog .dialog-titlebar .dot-r { background: #e94560; }
    .ui-dialog .dialog-titlebar .dot-y { background: #f0c040; }
    .ui-dialog .dialog-titlebar .dot-g { background: #0fb; }
    .ui-dialog .dialog-body { position: relative; padding: 10px; min-height: 80px; }

    /* ─── Button ─── */
    .ui-button {
      position: absolute; min-width: 60px; cursor: move; user-select: none;
      background: linear-gradient(135deg, #0f3460, #1a4080);
      border: 1px solid #1a5090; border-radius: 20px;
      padding: 8px 18px; font-size: 13px; color: #e0e0e0; text-align: center;
      box-shadow: 0 2px 8px #00000040; transition: box-shadow 0.15s;
    }
    .ui-button:hover { box-shadow: 0 2px 12px #0fb40; }
    .ui-button.selected { border-color: #0fb; box-shadow: 0 0 0 2px #0fb40, 0 2px 8px #00000040; }
    .ui-button.nested { position: absolute; }

    /* ─── Status Bar ─── */
    .console-bar {
      display: flex; align-items: center; padding: 4px 16px;
      background: #0d1b2a; border-top: 1px solid #0f3460; flex-shrink: 0;
      font-size: 12px; color: #666; gap: 12px;
    }
    .console-bar span { color: #0fb; }
    .console-bar .dirty { color: #f0c040; }
    .console-bar .ws-status { color: #666; }
    .console-bar .ws-status.on { color: #e040fb; }

    /* ─── Console Monitor ─── */
    #monitor {
      position: fixed; bottom: 28px; left: 0; width: 420px; z-index: 9999;
      background: #0d1b2a; border: 1px solid #0f3460; border-left: none;
      border-radius: 0 6px 0 0; font-family: 'Consolas', 'Courier New', monospace;
      display: flex; flex-direction: column;
    }
    #monitor-toolbar {
      display: flex; align-items: center; gap: 6px; padding: 4px 8px;
      background: #16213e; border-bottom: 1px solid #0f3460;
      border-radius: 0 6px 0 0; font-size: 11px; color: #8899aa;
      cursor: default; user-select: none;
    }
    #monitor-toolbar .monitor-title { font-weight: 600; color: #e94560; margin-right: auto; }
    #monitor-toolbar button {
      background: #0f3460; color: #8899aa; border: 1px solid #1a4080;
      padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;
    }
    #monitor-toolbar button:hover { background: #1a4080; color: #e0e0e0; }
    #monitor-toolbar button.active { color: #f0c040; border-color: #f0c040; }
    #monitor-log {
      height: 200px; overflow-y: auto; padding: 4px 8px; font-size: 11px;
      line-height: 1.5; resize: vertical; min-height: 80px;
    }
    #monitor-log::-webkit-scrollbar { width: 6px; }
    #monitor-log::-webkit-scrollbar-track { background: #0d1b2a; }
    #monitor-log::-webkit-scrollbar-thumb { background: #0f3460; border-radius: 3px; }
    #monitor-log .log-entry { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #monitor-log .log-time { color: #555; }
    #monitor-log .log-get { color: #4dd0e1; }
    #monitor-log .log-set { color: #66bb6a; }
    #monitor-log .log-change { color: #ffa726; }
    #monitor-log .log-detail { color: #8899aa; }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <h1>Element Store UI</h1>
      <button class="btn-dialog" onclick="addDialog()">+ Dialog</button>
      <button class="btn-button" onclick="addButton()">+ Button</button>
      <div class="sep"></div>
      <button class="btn-save" onclick="saveAll()">Save</button>
      <button class="btn-load" onclick="loadAll()">Load</button>
      <button class="btn-arrange" onclick="arrangeAll()">Arrange</button>
      <div class="sep"></div>
      <button class="btn-ws" id="btn-ws" onclick="toggleWS()">WS Connect</button>
      <button class="btn-inject" onclick="wsInjectDialog()">WS +Dialog</button>
      <button class="btn-inject" onclick="wsInjectChange()">WS Change</button>
      <button class="btn-clear" onclick="clearAll()">Clear All</button>
    </div>

    <div class="main">
      <div class="workspace" id="workspace">
        <div class="hint" id="hint">Click + Dialog or + Button to start</div>
      </div>

      <div class="panel">
        <div class="panel-header">Properties</div>
        <div id="panel-content">
          <div class="panel-empty">Select an element</div>
        </div>
      </div>
    </div>

    <div class="console-bar">
      <span id="obj-count">0</span> objects |
      <span id="dialog-count">0</span> dialogs |
      <span id="button-count">0</span> buttons |
      <span class="dirty" id="dirty-count">0</span> dirty |
      workspace: <span id="ws-id">-</span> |
      ws: <span class="ws-status" id="ws-status">off</span>
    </div>
  </div>

  <!-- Console Monitor Panel -->
  <div id="monitor">
    <div id="monitor-toolbar">
      <span class="monitor-title">Monitor</span>
      <button id="monitor-pause" onclick="toggleMonitorPause()">Pause</button>
      <button onclick="clearMonitorLog()">Clear</button>
    </div>
    <div id="monitor-log"></div>
  </div>

  <!-- Libraries -->
  <script src="element-store.js"></script>
  <script src="ui-element.js"></script>
  <script src="ws-client.js"></script>

  <!-- Console Monitor -->
  <script>
    var _monitorPaused = false;
    var _monitorMaxEntries = 500;
    var _monitorLogEl = document.getElementById('monitor-log');

    function monitorLog(type, detail) {
      if (_monitorPaused) return;

      var now = new Date();
      var time = String(now.getHours()).padStart(2, '0') + ':' +
                 String(now.getMinutes()).padStart(2, '0') + ':' +
                 String(now.getSeconds()).padStart(2, '0') + '.' +
                 String(now.getMilliseconds()).padStart(3, '0');

      var cssClass, label, info;
      switch (type) {
        case 'getObject':
          cssClass = 'log-get';
          label = 'GET';
          info = detail.id + (detail.classId ? ' [' + detail.classId + ']' : '') +
                 (detail.found ? '' : ' (miss)');
          break;
        case 'setObject':
          cssClass = 'log-set';
          label = 'SET';
          info = (detail.id || '(new)') + (detail.classId ? ' [' + detail.classId + ']' : '');
          break;
        case 'onChange':
          cssClass = 'log-change';
          label = 'CHG';
          info = (detail.id || detail._id || '?') +
                 ' .' + detail.prop + ' = ' + JSON.stringify(detail.value);
          break;
        default:
          cssClass = 'log-detail';
          label = type;
          info = JSON.stringify(detail);
      }

      var entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = '<span class="log-time">' + time + '</span> ' +
                         '<span class="' + cssClass + '">' + label + '</span> ' +
                         '<span class="log-detail">' + escapeMonitor(info) + '</span>';

      _monitorLogEl.appendChild(entry);

      // Trim old entries
      while (_monitorLogEl.children.length > _monitorMaxEntries) {
        _monitorLogEl.removeChild(_monitorLogEl.firstChild);
      }

      // Auto-scroll to bottom
      _monitorLogEl.scrollTop = _monitorLogEl.scrollHeight;
    }

    function escapeMonitor(s) {
      var d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function toggleMonitorPause() {
      _monitorPaused = !_monitorPaused;
      var btn = document.getElementById('monitor-pause');
      btn.textContent = _monitorPaused ? 'Resume' : 'Pause';
      if (_monitorPaused) btn.classList.add('active');
      else btn.classList.remove('active');
    }

    function clearMonitorLog() {
      _monitorLogEl.innerHTML = '';
    }

    // ── Monkey-patch store methods for monitoring ──

    var _origGetObject = store.getObject.bind(store);
    store.getObject = function(id, classId) {
      var result = _origGetObject(id, classId);
      monitorLog('getObject', {id: id, classId: classId, found: !!result});
      return result;
    };

    var _origSetObject = store.setObject.bind(store);
    store.setObject = function(obj) {
      var result = _origSetObject(obj);
      monitorLog('setObject', {id: result.id || result._id, classId: result.class_id});
      // Register onChange monitor on the new object
      registerMonitorOnChange(result);
      return result;
    };

    // Register onChange callback for monitor on an AtomObj
    function registerMonitorOnChange(obj) {
      if (!obj || !obj._onChange) return;
      // Avoid double-registering
      if (obj._onChange._monitorRegistered) return;
      obj._onChange.push(function(info) {
        monitorLog('onChange', {
          id: info.obj.data.id || null,
          _id: info.obj._id || null,
          prop: info.prop,
          value: info.value,
          oldValue: info.oldValue
        });
      });
      obj._onChange._monitorRegistered = true;
    }

    // Register onChange on existing store objects (seed data)
    Object.values(store.objects).forEach(function(obj) {
      if (obj && obj._onChange) registerMonitorOnChange(obj);
    });
  </script>

  <!-- Demo -->
  <script>
    // ═══════════════════════════════════════════════════════════════
    // UI classes are now seeded by ui-element.js via store.seed()
    // ═══════════════════════════════════════════════════════════════

    var idCounter = 0;
    function genId(prefix) { return prefix + '-' + (++idCounter); }

    // ═══════════════════════════════════════════════════════════════
    // WORKSPACE — the root container (an AtomObj, not AtomElement)
    // ═══════════════════════════════════════════════════════════════

    var ws;  // workspace AtomObj
    var selected = null;
    var workspaceEl = document.getElementById('workspace');

    function initWorkspace() {
      // Try to load workspace from store (local → remote fetch)
      ws = store.getObject('ws-1', 'ui-workspace');

      if (ws) {
        console.log('Loaded workspace from store:', ws.id, ws.data);
        document.getElementById('hint').style.display = 'none';

        // Load and render children (getObject fetches from remote if needed)
        if (Array.isArray(ws.data.children)) {
          // First pass: load all children from store
          // Each stored object has class_id — fetchRemote uses /find/{id} to resolve
          var loaded = [];
          ws.data.children.forEach(function(childId) {
            var child = store.getObject(childId);
            if (child) loaded.push(child);
          });

          // Render dialogs first (buttons may nest inside them)
          loaded.filter(function(c) { return c.data.class_id === 'ui-dialog'; })
                .forEach(function(c) { renderExistingChild(c); });
          loaded.filter(function(c) { return c.data.class_id !== 'ui-dialog'; })
                .forEach(function(c) { renderExistingChild(c); });

          // Sync idCounter so new ids don't collide
          ws.data.children.forEach(function(childId) {
            var num = parseInt(childId.split('-').pop(), 10);
            if (num >= idCounter) idCounter = num;
          });
        }
      } else {
        // No workspace in store — create one (saves to remote via setObject)
        ws = store.setObject({
          id: 'ws-1', class_id: 'ui-workspace',
          name: 'Main Workspace', children: []
        });
        console.log('Created new workspace:', ws.id);
      }

      document.getElementById('ws-id').textContent = ws.id;
    }

    function renderExistingChild(obj) {
      // Skip if already rendered
      if (obj.el) return;

      var el;
      if (obj.data.class_id === 'ui-dialog') {
        el = createDialogDom(obj);
      } else if (obj.data.class_id === 'ui-button') {
        el = createButtonDom(obj);
      }
      if (!el) return;

      obj.bind(el);
      obj.syncToDom();
      updateContent(obj);

      // Check if this element is a child of a dialog
      var parentDialog = findParentDialog(obj.id);
      if (parentDialog && parentDialog.el) {
        var body = parentDialog.el.querySelector('.dialog-body');
        el.classList.add('nested');
        body.appendChild(el);
      } else {
        workspaceEl.appendChild(el);
      }
    }

    function findParentDialog(childId) {
      var dialogs = store.find({class_id: 'ui-dialog'});
      for (var i = 0; i < dialogs.length; i++) {
        if (Array.isArray(dialogs[i].data.children) &&
            dialogs[i].data.children.indexOf(childId) >= 0) {
          return dialogs[i];
        }
      }
      return null;
    }

    // ═══════════════════════════════════════════════════════════════
    // DOM CREATION
    // ═══════════════════════════════════════════════════════════════

    function createDialogDom(obj) {
      var el = document.createElement('div');
      el.className = 'ui-dialog';
      el.innerHTML =
        '<div class="dialog-titlebar">' +
          '<div class="dots"><span class="dot dot-r"></span><span class="dot dot-y"></span><span class="dot dot-g"></span></div>' +
          '<span class="title-text">' + escHtml(obj.data.title) + '</span>' +
        '</div>' +
        '<div class="dialog-body"></div>';

      el.addEventListener('mousedown', function(e) {
        selectObj(this._atom);
        if (e.target.closest('.dialog-titlebar')) {
          startDrag(e, this._atom, false);
        }
        e.stopPropagation();
      });
      return el;
    }

    function createButtonDom(obj) {
      var el = document.createElement('div');
      el.className = 'ui-button';
      el.textContent = obj.data.text || 'Button';

      el.addEventListener('mousedown', function(e) {
        selectObj(this._atom);
        startDrag(e, this._atom, true);
        e.stopPropagation();
      });
      return el;
    }

    function updateContent(obj) {
      if (!obj.el) return;
      if (obj.data.class_id === 'ui-dialog') {
        var t = obj.el.querySelector('.title-text');
        if (t) t.textContent = obj.data.title || '';
      } else if (obj.data.class_id === 'ui-button') {
        obj.el.textContent = obj.data.text || 'Button';
      }
    }

    function escHtml(s) {
      var d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    // ═══════════════════════════════════════════════════════════════
    // ADD ELEMENTS — creates model + DOM, adds to workspace
    // ═══════════════════════════════════════════════════════════════

    function addDialog() {
      document.getElementById('hint').style.display = 'none';
      var id = genId('dlg');

      var obj = store.setObject({
        id: id, class_id: 'ui-dialog',
        x: 80 + Math.random() * 300,
        y: 40 + Math.random() * 200,
        width: 300, height: 200,
        title: 'Dialog ' + id.split('-')[1],
        children: []
      });

      var el = createDialogDom(obj);
      obj.bind(el);
      obj.syncToDom();
      workspaceEl.appendChild(el);

      // Add to workspace children
      ws.data.children.push(obj.id);

      selectObj(obj);
      updateCounts();
    }

    function addButton() {
      document.getElementById('hint').style.display = 'none';
      var id = genId('btn');

      var obj = store.setObject({
        id: id, class_id: 'ui-button',
        x: 100 + Math.random() * 400,
        y: 60 + Math.random() * 300,
        width: 120, height: 36,
        text: 'Button ' + id.split('-')[1]
      });

      var el = createButtonDom(obj);
      obj.bind(el);
      obj.syncToDom();
      workspaceEl.appendChild(el);

      // Add to workspace children
      ws.data.children.push(obj.id);

      selectObj(obj);
      updateCounts();
    }

    function clearAll() {
      // Destroy all UI elements
      var uiObjects = store.find({class_id: 'ui-dialog'}).concat(store.find({class_id: 'ui-button'}));
      uiObjects.forEach(function(obj) {
        if (obj.destroy) obj.destroy();
        delete store.objects[obj.id];
      });
      // Clear workspace children
      ws.data.children = [];
      selected = null;
      renderPanel();
      updateCounts();
      document.getElementById('hint').style.display = '';
    }

    // ═══════════════════════════════════════════════════════════════
    // SAVE — saves the entire design (workspace + all children)
    // Collects ALL objects in the design tree and saves each one.
    // ═══════════════════════════════════════════════════════════════

    function collectDesignObjects() {
      var all = [];
      if (!ws) return all;
      all.push(ws);

      if (Array.isArray(ws.data.children)) {
        ws.data.children.forEach(function(childId) {
          var child = store.objects[childId];
          if (child) {
            all.push(child);
            // Dialog's nested children (buttons inside dialogs)
            if (Array.isArray(child.data.children)) {
              child.data.children.forEach(function(nestedId) {
                var nested = store.objects[nestedId];
                if (nested) all.push(nested);
              });
            }
          }
        });
      }
      return all;
    }

    function saveAll() {
      var all = collectDesignObjects();
      var dirty = all.filter(function(obj) {
        return obj.hasChanges && obj.hasChanges();
      });

      if (dirty.length === 0) {
        console.log('Nothing to save — all clean');
        monitorLog('SAVE', { info: 'All clean, nothing to save' });
        return;
      }

      console.group('Saving design: ' + dirty.length + '/' + all.length + ' dirty objects');
      dirty.forEach(function(obj) {
        var changes = obj.getChanges();
        console.log(obj.id + ':', changes);

        // Save to remote (each save triggers PHP broadcast to WS subscribers)
        if (store.storage) store.saveRemote(obj);

        // Mark clean
        obj._snapshot = JSON.parse(JSON.stringify(obj.data));
      });
      console.groupEnd();

      monitorLog('SAVE', { info: 'Saved ' + dirty.length + ' objects in design ' + ws.id });
      updateCounts();
      if (selected) renderPanel();
    }

    // ═══════════════════════════════════════════════════════════════
    // ARRANGE — simulates external changes via applyRemote
    // ═══════════════════════════════════════════════════════════════

    function arrangeAll() {
      var dialogs = store.find({class_id: 'ui-dialog'});
      if (dialogs.length === 0) {
        console.log('Nothing to arrange');
        return;
      }

      var changes = [];
      var xOffset = 20;

      // Line up dialogs side by side
      dialogs.forEach(function(dlg, i) {
        changes.push({
          id: dlg.id, class_id: 'ui-dialog',
          x: xOffset + i * 320, y: 20,
          width: 300, height: 200
        });

        // Stack buttons inside each dialog
        if (Array.isArray(dlg.data.children)) {
          dlg.data.children.forEach(function(btnId, j) {
            changes.push({
              id: btnId, class_id: 'ui-button',
              x: 10, y: 10 + j * 46,
              width: 120, height: 36
            });
          });
        }
      });

      // Also arrange free-standing buttons
      var freeButtons = store.find({class_id: 'ui-button'}).filter(function(btn) {
        return !findParentDialog(btn.id);
      });
      freeButtons.forEach(function(btn, i) {
        changes.push({
          id: btn.id, class_id: 'ui-button',
          x: 20 + dialogs.length * 320 + 20,
          y: 20 + i * 46,
          width: 120, height: 36
        });
      });

      // Apply as external changes — data + snapshot + DOM all update
      console.group('Arrange: applying ' + changes.length + ' external changes');
      changes.forEach(function(c) {
        var obj = store.applyRemote(c);
        updateContent(obj);
        console.log(c.id + ' → x:' + c.x + ' y:' + c.y);
      });
      console.groupEnd();

      updateCounts();
      if (selected) renderPanel();
    }

    // ═══════════════════════════════════════════════════════════════
    // SELECTION
    // ═══════════════════════════════════════════════════════════════

    function selectObj(obj) {
      if (selected && selected.el) selected.el.classList.remove('selected');
      selected = obj || null;
      if (selected && selected.el) selected.el.classList.add('selected');
      renderPanel();
    }

    workspaceEl.addEventListener('mousedown', function(e) {
      if (e.target === this || e.target.id === 'hint') selectObj(null);
    });

    // ═══════════════════════════════════════════════════════════════
    // DRAG & DROP
    // ═══════════════════════════════════════════════════════════════

    function startDrag(e, atom, canDrop) {
      if (!atom || !atom.el) return;

      var startX = e.clientX;
      var startY = e.clientY;
      var origX = atom.data.x;
      var origY = atom.data.y;

      function onMove(e2) {
        atom.data.x = origX + (e2.clientX - startX);
        atom.data.y = origY + (e2.clientY - startY);
        atom.syncToDom();
        if (selected === atom) updatePanelValues();
      }

      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (canDrop && atom.data.class_id === 'ui-button') {
          tryDropOnDialog(atom);
        }
        updateCounts();  // dirty count may have changed
      }

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }

    function tryDropOnDialog(btnAtom) {
      var btnEl = btnAtom.el;
      var btnRect = btnEl.getBoundingClientRect();
      var btnCx = btnRect.left + btnRect.width / 2;
      var btnCy = btnRect.top + btnRect.height / 2;

      var currentParent = btnEl.parentNode;
      var isNested = currentParent.classList && currentParent.classList.contains('dialog-body');

      // Find dialog under button center
      var targetDialog = null;
      var dialogs = store.find({class_id: 'ui-dialog'});
      for (var i = 0; i < dialogs.length; i++) {
        var dlg = dialogs[i];
        if (!dlg.el) continue;
        var r = dlg.el.getBoundingClientRect();
        if (btnCx >= r.left && btnCx <= r.right && btnCy >= r.top && btnCy <= r.bottom) {
          targetDialog = dlg;
          break;
        }
      }

      if (targetDialog) {
        var dlgBody = targetDialog.el.querySelector('.dialog-body');
        var dlgRect = dlgBody.getBoundingClientRect();

        if (isNested && currentParent === dlgBody) return;
        if (isNested) unnestButton(btnAtom);

        // Convert to relative coords
        var wsRect = workspaceEl.getBoundingClientRect();
        btnAtom.data.x = Math.max(0, btnAtom.data.x - (dlgRect.left - wsRect.left));
        btnAtom.data.y = Math.max(0, btnAtom.data.y - (dlgRect.top - wsRect.top));
        btnAtom.syncToDom();

        // Add to dialog children
        if (!Array.isArray(targetDialog.data.children)) targetDialog.data.children = [];
        if (targetDialog.data.children.indexOf(btnAtom.id) === -1) {
          targetDialog.data.children.push(btnAtom.id);
        }

        btnEl.classList.add('nested');
        dlgBody.appendChild(btnEl);
        if (selected) updatePanelValues();
        console.log(targetDialog.id + '.children =', targetDialog.data.children);

      } else if (isNested) {
        var wsRect = workspaceEl.getBoundingClientRect();
        var absX = btnRect.left - wsRect.left;
        var absY = btnRect.top - wsRect.top;
        unnestButton(btnAtom);
        btnAtom.data.x = absX;
        btnAtom.data.y = absY;
        btnAtom.syncToDom();
        workspaceEl.appendChild(btnEl);
        btnEl.classList.remove('nested');
        if (selected) updatePanelValues();
      }
    }

    function unnestButton(btnAtom) {
      var dialogs = store.find({class_id: 'ui-dialog'});
      for (var i = 0; i < dialogs.length; i++) {
        var dlg = dialogs[i];
        if (Array.isArray(dlg.data.children)) {
          var idx = dlg.data.children.indexOf(btnAtom.id);
          if (idx >= 0) {
            dlg.data.children.splice(idx, 1);
            break;
          }
        }
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // PROPERTIES PANEL
    // ═══════════════════════════════════════════════════════════════

    function renderPanel() {
      var container = document.getElementById('panel-content');
      if (!selected) {
        container.innerHTML = '<div class="panel-empty">Select an element</div>';
        return;
      }
      var obj = selected;
      var isDirty = obj.hasChanges();
      var html = '';

      // Identity
      html += '<div class="panel-section"><h3>Identity</h3>';
      html += propRowReadonly('id', obj.id);
      html += propRowReadonly('class', obj.class_id);
      var classObj = store.objects[obj.class_id];
      if (classObj && classObj.data.extends_id) {
        html += propRowReadonly('extends', classObj.data.extends_id);
      }
      html += propRowReadonly('type', obj.constructor.name);
      html += propRowReadonly('dirty', isDirty ? 'yes' : 'no', isDirty);
      html += '</div>';

      // Properties
      html += '<div class="panel-section"><h3>Properties</h3>';
      var props = store.collectClassProps(obj.class_id);
      props.forEach(function(propDef) {
        var dotIdx = propDef.id.lastIndexOf('.');
        var key = dotIdx >= 0 ? propDef.id.substring(dotIdx + 1) : propDef.id;
        if (key === 'children') {
          var ids = obj.data.children || [];
          html += propRowReadonly('children', ids.length > 0 ? ids.join(', ') : '(none)');
        } else {
          var val = obj.data[key];
          if (val === undefined || val === null) val = '';
          html += propRowEditable(key, val, propDef.data_type || 'string');
        }
      });
      html += '</div>';

      // Raw data
      html += '<div class="panel-section"><h3>Raw Data</h3>';
      html += '<pre style="font-size:11px;color:#8899aa;white-space:pre-wrap;word-break:break-all">' +
        escHtml(JSON.stringify(obj.data, null, 2)) + '</pre>';
      html += '</div>';

      container.innerHTML = html;

      // Bind inputs → model → DOM
      container.querySelectorAll('.prop-value').forEach(function(input) {
        input.addEventListener('change', function() {
          var key = this.dataset.key;
          var type = this.dataset.type;
          var val = this.value;
          if (type === 'float' || type === 'integer') val = parseFloat(val) || 0;
          obj.data[key] = val;
          obj.syncToDom();
          updateContent(obj);
          updateRawDisplay();
          updateCounts();
        });
      });
    }

    function propRowReadonly(label, value, highlight) {
      var cls = highlight ? 'prop-readonly prop-dirty' : 'prop-readonly';
      return '<div class="prop-row"><span class="prop-label">' + label +
        '</span><span class="' + cls + '">' + escHtml(String(value)) + '</span></div>';
    }

    function propRowEditable(key, value, type) {
      var inputType = (type === 'float' || type === 'integer') ? 'number' : 'text';
      var step = type === 'float' ? 'any' : '1';
      return '<div class="prop-row"><span class="prop-label">' + key +
        '</span><input class="prop-value" type="' + inputType + '" step="' + step +
        '" data-key="' + key + '" data-type="' + type +
        '" value="' + escHtml(String(value)) + '"></div>';
    }

    function updatePanelValues() {
      if (!selected) return;
      var container = document.getElementById('panel-content');
      container.querySelectorAll('.prop-value').forEach(function(input) {
        var key = input.dataset.key;
        var val = selected.data[key];
        if (val === undefined || val === null) val = '';
        if (document.activeElement !== input) input.value = val;
      });
      updateRawDisplay();
    }

    function updateRawDisplay() {
      if (!selected) return;
      var pre = document.querySelector('#panel-content pre');
      if (pre) pre.textContent = JSON.stringify(selected.data, null, 2);
    }

    // ═══════════════════════════════════════════════════════════════
    // STATUS BAR — counts + dirty indicator
    // ═══════════════════════════════════════════════════════════════

    function updateCounts() {
      var dialogs = store.find({class_id: 'ui-dialog'});
      var buttons = store.find({class_id: 'ui-button'});
      document.getElementById('obj-count').textContent = dialogs.length + buttons.length;
      document.getElementById('dialog-count').textContent = dialogs.length;
      document.getElementById('button-count').textContent = buttons.length;

      // Count dirty objects (workspace + all UI elements)
      var dirtyCount = 0;
      if (ws && ws.hasChanges()) dirtyCount++;
      dialogs.concat(buttons).forEach(function(obj) {
        if (obj.hasChanges()) dirtyCount++;
      });
      document.getElementById('dirty-count').textContent = dirtyCount;
    }

    // ═══════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════

    initWorkspace();

    console.log('Classes:', store.find({class_id: '@class'}).map(function(c) { return c.id; }));
    console.log('Workspace:', ws.id, '| children:', ws.data.children);
    updateCounts();

    // ═══════════════════════════════════════════════════════════════
    // LOAD — fetch workspace + children from server
    // ═══════════════════════════════════════════════════════════════

    function loadAll() {
      // Clear current UI
      var uiObjects = store.find({class_id: 'ui-dialog'}).concat(store.find({class_id: 'ui-button'}));
      uiObjects.forEach(function(obj) {
        if (obj.destroy) obj.destroy();
        delete store.objects[obj.id];
      });
      selected = null;

      // Delete workspace from local cache to force fresh fetch
      delete store.objects['ws-1'];

      // Re-init workspace (fetches from remote)
      initWorkspace();
      renderPanel();
      updateCounts();
      monitorLog('LOAD', { info: 'Loaded workspace + ' + (ws.data.children ? ws.data.children.length : 0) + ' children from server' });
    }

    // ═══════════════════════════════════════════════════════════════
    // WEBSOCKET — connect, subscribe, receive real-time changes
    // ═══════════════════════════════════════════════════════════════

    var esws = null;

    function getWsUrl() {
      // Derive WS URL from current page location
      var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      var basePath = API_BASE || '';
      return proto + '//' + location.host + basePath + '/ws';
    }

    function toggleWS() {
      if (esws && esws.ws && esws.ws.readyState <= 1) {
        // Connected or connecting — disconnect
        esws.disconnect();
        esws = null;
        updateWsUI(false);
        monitorLog('WS', { info: 'Disconnected' });
      } else {
        // Connect
        esws = new ElementStoreWS(store, getWsUrl());

        esws.on('connected', function(msg) {
          updateWsUI(true);
          monitorLog('WS', { info: 'Connected as user=' + (msg.user_id || 'anonymous') });
          // Subscribe to the design by workspace ID
          esws.subscribeScope(ws.id);
        });

        esws.on('subscribed', function(msg) {
          monitorLog('WS', { info: 'Subscribed: ' + (msg.scope_id || msg.class_id || msg.id) });
        });

        esws.on('change', function(item) {
          monitorLog('WS-IN', { info: 'Change: ' + item.id + ' [' + item.class_id + ']' });
          // If the changed object has a DOM element, update its content
          var obj = store.objects[item.id];
          if (obj) {
            updateContent(obj);
            // If new object without DOM, render it
            if (!obj.el && (item.class_id === 'ui-dialog' || item.class_id === 'ui-button')) {
              renderExistingChild(obj);
            }
          }
          // If workspace changed, sync children list
          if (item.id === 'ws-1' && item.class_id === 'ui-workspace') {
            syncWorkspaceChildren();
          }
          updateCounts();
          if (selected && selected.id === item.id) renderPanel();
        });

        esws.on('delete', function(item) {
          monitorLog('WS-IN', { info: 'Deleted: ' + item.id + ' [' + item.class_id + ']' });
          // Remove DOM if it exists
          var obj = store.objects[item.id];
          if (obj && obj.destroy) obj.destroy();
          updateCounts();
          if (selected && selected.id === item.id) {
            selected = null;
            renderPanel();
          }
        });

        esws.on('close', function() {
          updateWsUI(false);
        });

        // Connect (with JWT token if available, or anonymous)
        var opts = {};
        if (typeof getJwtToken === 'function' && getJwtToken()) {
          opts.token = getJwtToken();
        }
        esws.connect(opts);
      }
    }

    function updateWsUI(connected) {
      var btn = document.getElementById('btn-ws');
      var status = document.getElementById('ws-status');
      if (connected) {
        btn.textContent = 'WS Disconnect';
        btn.classList.add('connected');
        status.textContent = 'on';
        status.classList.add('on');
      } else {
        btn.textContent = 'WS Connect';
        btn.classList.remove('connected');
        status.textContent = 'off';
        status.classList.remove('on');
      }
    }

    // When workspace children list changes from WS, render any new children
    function syncWorkspaceChildren() {
      if (!ws || !Array.isArray(ws.data.children)) return;
      ws.data.children.forEach(function(childId) {
        var obj = store.objects[childId];
        if (!obj) {
          // Try to fetch from remote
          obj = store.getObject(childId);
        }
        if (obj && !obj.el) {
          renderExistingChild(obj);
        }
      });
    }

    // ═══════════════════════════════════════════════════════════════
    // WS INJECT — simulate external changes via WS broadcast
    // ═══════════════════════════════════════════════════════════════

    var injectCounter = 0;

    // Inject a new dialog via the WS broadcast endpoint (simulates another client saving)
    function wsInjectDialog() {
      injectCounter++;
      var dlgId = 'ws-dlg-' + injectCounter;
      var scopeId = ws.id; // tag all items with their parent scope
      var dlgData = {
        id: dlgId,
        class_id: 'ui-dialog',
        _scope_id: scopeId,
        x: 50 + Math.random() * 300,
        y: 50 + Math.random() * 200,
        width: 280,
        height: 180,
        title: 'WS Dialog #' + injectCounter,
        children: []
      };

      // Also add a button inside it
      var btnId = 'ws-btn-' + injectCounter;
      var btnData = {
        id: btnId,
        class_id: 'ui-button',
        _scope_id: scopeId,
        x: 10,
        y: 10,
        width: 120,
        height: 36,
        text: 'WS Button #' + injectCounter
      };
      dlgData.children = [btnId];

      // Also update workspace children
      var wsChildren = ws.data.children.slice();
      wsChildren.push(dlgId);

      var broadcast = {
        type: 'changes',
        items: [
          dlgData,
          btnData,
          { id: 'ws-1', class_id: 'ui-workspace', _scope_id: scopeId, name: 'Main Workspace', children: wsChildren }
        ]
      };

      postBroadcast(broadcast);
      monitorLog('WS-OUT', { info: 'Injected dialog ' + dlgId + ' + button ' + btnId });
    }

    // Change a random existing element's position/title via WS broadcast
    function wsInjectChange() {
      var dialogs = store.find({class_id: 'ui-dialog'});
      var buttons = store.find({class_id: 'ui-button'});
      var all = dialogs.concat(buttons);

      if (all.length === 0) {
        monitorLog('WS-OUT', { info: 'No elements to change — add some first' });
        return;
      }

      var target = all[Math.floor(Math.random() * all.length)];
      var item = {
        id: target.id,
        class_id: target.data.class_id,
        _scope_id: ws.id,
        x: Math.round(20 + Math.random() * 400),
        y: Math.round(20 + Math.random() * 300)
      };

      // Also change title/text
      if (target.data.class_id === 'ui-dialog') {
        item.title = 'Moved! ' + new Date().toLocaleTimeString();
      } else {
        item.text = 'Moved! ' + new Date().toLocaleTimeString();
      }

      var broadcast = {
        type: 'changes',
        items: [item]
      };

      postBroadcast(broadcast);
      monitorLog('WS-OUT', { info: 'Changed ' + target.id + ' → x:' + item.x + ' y:' + item.y });
    }

    // POST directly to the WS server broadcast endpoint
    function postBroadcast(msg) {
      var wsServerUrl = (API_BASE || '') + '/ws-broadcast';
      // In dev/local mode, try direct to WS server port
      var url = location.protocol + '//' + location.hostname + ':19008/broadcast';

      var xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      // Don't set X-Sender-User-Id so we DO receive the echo (for testing)
      xhr.onload = function() {
        if (xhr.status === 200) {
          var resp = JSON.parse(xhr.responseText);
          monitorLog('WS-OUT', { info: 'Broadcast sent → ' + resp.sent + ' clients received' });
        } else {
          monitorLog('WS-OUT', { info: 'Broadcast failed: HTTP ' + xhr.status });
        }
      };
      xhr.onerror = function() {
        monitorLog('WS-OUT', { info: 'Broadcast failed: network error (is WS server running on :19008?)' });
      };
      xhr.send(JSON.stringify(msg));
    }
  </script>
</body>
</html>
