<!DOCTYPE html>
<html>
<head>
  <title>Element Store — UI Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a2e; color: #e0e0e0; overflow: hidden; height: 100vh; }

    /* ─── Layout ─── */
    .app { display: flex; flex-direction: column; height: 100vh; }

    .toolbar {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; background: #16213e; border-bottom: 1px solid #0f3460;
      flex-shrink: 0; flex-wrap: wrap;
    }
    .toolbar h1 { font-size: 15px; color: #e94560; margin-right: 12px; font-weight: 600; }
    .toolbar .sep { width: 1px; height: 24px; background: #0f3460; margin: 0 4px; }

    .toolbar button {
      background: #0f3460; color: #e0e0e0; border: 1px solid #1a4080;
      padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;
      transition: background 0.15s;
    }
    .toolbar button:hover { background: #1a4080; }
    .toolbar .btn-dialog { border-color: #e94560; color: #e94560; }
    .toolbar .btn-dialog:hover { background: #e94560; color: #fff; }
    .toolbar .btn-button { border-color: #0fb; color: #0fb; }
    .toolbar .btn-button:hover { background: #0fb; color: #1a1a2e; }
    .toolbar .btn-save { border-color: #4caf50; color: #4caf50; }
    .toolbar .btn-save:hover { background: #4caf50; color: #fff; }
    .toolbar .btn-arrange { border-color: #f0c040; color: #f0c040; }
    .toolbar .btn-arrange:hover { background: #f0c040; color: #1a1a2e; }
    .toolbar .btn-clear { margin-left: auto; border-color: #666; color: #888; font-size: 11px; }
    .toolbar .btn-clear:hover { background: #444; color: #ccc; }

    .main { display: flex; flex: 1; overflow: hidden; }

    /* ─── Workspace ─── */
    .workspace {
      flex: 1; position: relative; overflow: hidden;
      background:
        radial-gradient(circle at 50% 50%, #1e2745 0%, #1a1a2e 70%),
        repeating-linear-gradient(0deg, transparent, transparent 29px, #ffffff06 29px, #ffffff06 30px),
        repeating-linear-gradient(90deg, transparent, transparent 29px, #ffffff06 29px, #ffffff06 30px);
    }
    .workspace .hint {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #ffffff20; font-size: 22px; pointer-events: none; user-select: none;
    }

    /* ─── Properties Panel ─── */
    .panel {
      width: 280px; background: #16213e; border-left: 1px solid #0f3460;
      overflow-y: auto; flex-shrink: 0;
    }
    .panel-header {
      padding: 10px 14px; background: #0f3460; font-size: 13px; font-weight: 600;
      color: #e94560; border-bottom: 1px solid #1a4080;
    }
    .panel-empty {
      padding: 20px 14px; color: #ffffff40; font-size: 13px; text-align: center;
    }
    .panel-section { padding: 10px 14px; border-bottom: 1px solid #0f346040; }
    .panel-section h3 {
      font-size: 11px; text-transform: uppercase; color: #e94560; margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .prop-row { display: flex; align-items: center; margin-bottom: 6px; gap: 6px; }
    .prop-label { width: 80px; font-size: 12px; color: #8899aa; flex-shrink: 0; }
    .prop-value {
      flex: 1; background: #1a1a2e; border: 1px solid #0f3460; color: #e0e0e0;
      padding: 4px 8px; border-radius: 3px; font-size: 12px; font-family: monospace; outline: none;
    }
    .prop-value:focus { border-color: #e94560; }
    .prop-readonly { color: #666; font-size: 12px; font-family: monospace; }
    .prop-dirty { color: #f0c040; }

    /* ─── Dialog ─── */
    .ui-dialog {
      position: absolute; min-width: 160px; min-height: 100px;
      background: #1e2745; border: 1px solid #0f3460; border-radius: 6px;
      box-shadow: 0 4px 20px #00000060;
    }
    .ui-dialog.selected { border-color: #e94560; box-shadow: 0 0 0 2px #e9456040, 0 4px 20px #00000060; }
    .ui-dialog .dialog-titlebar {
      display: flex; align-items: center; padding: 6px 10px;
      background: #0f3460; border-radius: 5px 5px 0 0; cursor: move;
      user-select: none; font-size: 13px; font-weight: 600; color: #e0e0e0;
    }
    .ui-dialog .dialog-titlebar .dots { display: flex; gap: 4px; margin-right: 8px; }
    .ui-dialog .dialog-titlebar .dot { width: 8px; height: 8px; border-radius: 50%; }
    .ui-dialog .dialog-titlebar .dot-r { background: #e94560; }
    .ui-dialog .dialog-titlebar .dot-y { background: #f0c040; }
    .ui-dialog .dialog-titlebar .dot-g { background: #0fb; }
    .ui-dialog .dialog-body { position: relative; padding: 10px; min-height: 80px; }

    /* ─── Button ─── */
    .ui-button {
      position: absolute; min-width: 60px; cursor: move; user-select: none;
      background: linear-gradient(135deg, #0f3460, #1a4080);
      border: 1px solid #1a5090; border-radius: 20px;
      padding: 8px 18px; font-size: 13px; color: #e0e0e0; text-align: center;
      box-shadow: 0 2px 8px #00000040; transition: box-shadow 0.15s;
    }
    .ui-button:hover { box-shadow: 0 2px 12px #0fb40; }
    .ui-button.selected { border-color: #0fb; box-shadow: 0 0 0 2px #0fb40, 0 2px 8px #00000040; }
    .ui-button.nested { position: absolute; }

    /* ─── Status Bar ─── */
    .console-bar {
      display: flex; align-items: center; padding: 4px 16px;
      background: #0d1b2a; border-top: 1px solid #0f3460; flex-shrink: 0;
      font-size: 12px; color: #666; gap: 12px;
    }
    .console-bar span { color: #0fb; }
    .console-bar .dirty { color: #f0c040; }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <h1>Element Store UI</h1>
      <button class="btn-dialog" onclick="addDialog()">+ Dialog</button>
      <button class="btn-button" onclick="addButton()">+ Button</button>
      <div class="sep"></div>
      <button class="btn-save" onclick="saveAll()">Save</button>
      <button class="btn-arrange" onclick="arrangeAll()">Arrange</button>
      <button class="btn-clear" onclick="clearAll()">Clear All</button>
    </div>

    <div class="main">
      <div class="workspace" id="workspace">
        <div class="hint" id="hint">Click + Dialog or + Button to start</div>
      </div>

      <div class="panel">
        <div class="panel-header">Properties</div>
        <div id="panel-content">
          <div class="panel-empty">Select an element</div>
        </div>
      </div>
    </div>

    <div class="console-bar">
      <span id="obj-count">0</span> objects |
      <span id="dialog-count">0</span> dialogs |
      <span id="button-count">0</span> buttons |
      <span class="dirty" id="dirty-count">0</span> dirty |
      workspace: <span id="ws-id">-</span>
    </div>
  </div>

  <!-- Libraries -->
  <script src="element-store.js"></script>
  <script src="ui-element.js"></script>

  <!-- Demo -->
  <script>
    // ═══════════════════════════════════════════════════════════════
    // SEED UI CLASSES
    // ═══════════════════════════════════════════════════════════════

    var idCounter = 0;
    function genId(prefix) { return prefix + '-' + (++idCounter); }

    function seedUIClasses() {
      // ui-element (base)
      store.setObject({id: 'ui-element', class_id: '@class', name: 'UI Element'});
      store.setObject({id: 'ui-element.x',      class_id: '@prop', data_type: 'float', default_value: 0});
      store.setObject({id: 'ui-element.y',      class_id: '@prop', data_type: 'float', default_value: 0});
      store.setObject({id: 'ui-element.width',  class_id: '@prop', data_type: 'float', default_value: 100});
      store.setObject({id: 'ui-element.height', class_id: '@prop', data_type: 'float', default_value: 40});
      store.setObject({id: 'ui-element.label',  class_id: '@prop', data_type: 'string', default_value: ''});

      // ui-dialog (extends ui-element)
      store.setObject({id: 'ui-dialog', class_id: '@class', name: 'Dialog', extends_id: 'ui-element'});
      store.setObject({id: 'ui-dialog.title',    class_id: '@prop', data_type: 'string', default_value: 'Dialog'});
      store.setObject({id: 'ui-dialog.children', class_id: '@prop', data_type: 'relation', is_array: true, object_class_id: 'ui-element'});

      // ui-button (extends ui-element)
      store.setObject({id: 'ui-button', class_id: '@class', name: 'Button', extends_id: 'ui-element'});
      store.setObject({id: 'ui-button.text', class_id: '@prop', data_type: 'string', default_value: 'Click me'});

      // ui-workspace
      store.setObject({id: 'ui-workspace', class_id: '@class', name: 'Workspace'});
      store.setObject({id: 'ui-workspace.name',     class_id: '@prop', data_type: 'string', default_value: 'Workspace'});
      store.setObject({id: 'ui-workspace.children', class_id: '@prop', data_type: 'relation', is_array: true, object_class_id: 'ui-element'});
    }

    seedUIClasses();

    // ═══════════════════════════════════════════════════════════════
    // WORKSPACE — the root container (an AtomObj, not AtomElement)
    // ═══════════════════════════════════════════════════════════════

    var ws;  // workspace AtomObj
    var selected = null;
    var workspaceEl = document.getElementById('workspace');

    function initWorkspace() {
      // Try to load workspace from store (local → remote fetch)
      ws = store.getObject('ws-1', 'ui-workspace');

      if (ws) {
        console.log('Loaded workspace from store:', ws.id, ws.data);
        document.getElementById('hint').style.display = 'none';

        // Load and render children (getObject fetches from remote if needed)
        if (Array.isArray(ws.data.children)) {
          // First pass: load all children from store
          // Each stored object has class_id — fetchRemote uses /find/{id} to resolve
          var loaded = [];
          ws.data.children.forEach(function(childId) {
            var child = store.getObject(childId);
            if (child) loaded.push(child);
          });

          // Render dialogs first (buttons may nest inside them)
          loaded.filter(function(c) { return c.data.class_id === 'ui-dialog'; })
                .forEach(function(c) { renderExistingChild(c); });
          loaded.filter(function(c) { return c.data.class_id !== 'ui-dialog'; })
                .forEach(function(c) { renderExistingChild(c); });

          // Sync idCounter so new ids don't collide
          ws.data.children.forEach(function(childId) {
            var num = parseInt(childId.split('-').pop(), 10);
            if (num >= idCounter) idCounter = num;
          });
        }
      } else {
        // No workspace in store — create one (saves to remote via setObject)
        ws = store.setObject({
          id: 'ws-1', class_id: 'ui-workspace',
          name: 'Main Workspace', children: []
        });
        console.log('Created new workspace:', ws.id);
      }

      document.getElementById('ws-id').textContent = ws.id;
    }

    function renderExistingChild(obj) {
      // Skip if already rendered
      if (obj.el) return;

      var el;
      if (obj.data.class_id === 'ui-dialog') {
        el = createDialogDom(obj);
      } else if (obj.data.class_id === 'ui-button') {
        el = createButtonDom(obj);
      }
      if (!el) return;

      obj.bind(el);
      obj.syncToDom();
      updateContent(obj);

      // Check if this element is a child of a dialog
      var parentDialog = findParentDialog(obj.id);
      if (parentDialog && parentDialog.el) {
        var body = parentDialog.el.querySelector('.dialog-body');
        el.classList.add('nested');
        body.appendChild(el);
      } else {
        workspaceEl.appendChild(el);
      }
    }

    function findParentDialog(childId) {
      var dialogs = store.find({class_id: 'ui-dialog'});
      for (var i = 0; i < dialogs.length; i++) {
        if (Array.isArray(dialogs[i].data.children) &&
            dialogs[i].data.children.indexOf(childId) >= 0) {
          return dialogs[i];
        }
      }
      return null;
    }

    // ═══════════════════════════════════════════════════════════════
    // DOM CREATION
    // ═══════════════════════════════════════════════════════════════

    function createDialogDom(obj) {
      var el = document.createElement('div');
      el.className = 'ui-dialog';
      el.innerHTML =
        '<div class="dialog-titlebar">' +
          '<div class="dots"><span class="dot dot-r"></span><span class="dot dot-y"></span><span class="dot dot-g"></span></div>' +
          '<span class="title-text">' + escHtml(obj.data.title) + '</span>' +
        '</div>' +
        '<div class="dialog-body"></div>';

      el.addEventListener('mousedown', function(e) {
        selectObj(this._atom);
        if (e.target.closest('.dialog-titlebar')) {
          startDrag(e, this._atom, false);
        }
        e.stopPropagation();
      });
      return el;
    }

    function createButtonDom(obj) {
      var el = document.createElement('div');
      el.className = 'ui-button';
      el.textContent = obj.data.text || 'Button';

      el.addEventListener('mousedown', function(e) {
        selectObj(this._atom);
        startDrag(e, this._atom, true);
        e.stopPropagation();
      });
      return el;
    }

    function updateContent(obj) {
      if (!obj.el) return;
      if (obj.data.class_id === 'ui-dialog') {
        var t = obj.el.querySelector('.title-text');
        if (t) t.textContent = obj.data.title || '';
      } else if (obj.data.class_id === 'ui-button') {
        obj.el.textContent = obj.data.text || 'Button';
      }
    }

    function escHtml(s) {
      var d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    // ═══════════════════════════════════════════════════════════════
    // ADD ELEMENTS — creates model + DOM, adds to workspace
    // ═══════════════════════════════════════════════════════════════

    function addDialog() {
      document.getElementById('hint').style.display = 'none';
      var id = genId('dlg');

      var obj = store.setObject({
        id: id, class_id: 'ui-dialog',
        x: 80 + Math.random() * 300,
        y: 40 + Math.random() * 200,
        width: 300, height: 200,
        title: 'Dialog ' + id.split('-')[1],
        children: []
      });

      var el = createDialogDom(obj);
      obj.bind(el);
      obj.syncToDom();
      workspaceEl.appendChild(el);

      // Add to workspace children
      ws.data.children.push(obj.id);

      selectObj(obj);
      updateCounts();
    }

    function addButton() {
      document.getElementById('hint').style.display = 'none';
      var id = genId('btn');

      var obj = store.setObject({
        id: id, class_id: 'ui-button',
        x: 100 + Math.random() * 400,
        y: 60 + Math.random() * 300,
        width: 120, height: 36,
        text: 'Button ' + id.split('-')[1]
      });

      var el = createButtonDom(obj);
      obj.bind(el);
      obj.syncToDom();
      workspaceEl.appendChild(el);

      // Add to workspace children
      ws.data.children.push(obj.id);

      selectObj(obj);
      updateCounts();
    }

    function clearAll() {
      // Destroy all UI elements
      var uiObjects = store.find({class_id: 'ui-dialog'}).concat(store.find({class_id: 'ui-button'}));
      uiObjects.forEach(function(obj) {
        if (obj.destroy) obj.destroy();
        delete store.objects[obj.id];
      });
      // Clear workspace children
      ws.data.children = [];
      selected = null;
      renderPanel();
      updateCounts();
      document.getElementById('hint').style.display = '';
    }

    // ═══════════════════════════════════════════════════════════════
    // SAVE — saves workspace + all dirty children
    // ═══════════════════════════════════════════════════════════════

    function saveAll() {
      var dirty = [];

      // Check workspace
      if (ws.hasChanges()) dirty.push(ws);

      // Check all workspace children
      if (Array.isArray(ws.data.children)) {
        ws.data.children.forEach(function(childId) {
          var child = store.objects[childId];
          if (child && child.hasChanges && child.hasChanges()) {
            dirty.push(child);
          }
          // Also check dialog's nested children
          if (child && Array.isArray(child.data.children)) {
            child.data.children.forEach(function(nestedId) {
              var nested = store.objects[nestedId];
              if (nested && nested.hasChanges && nested.hasChanges()) {
                dirty.push(nested);
              }
            });
          }
        });
      }

      if (dirty.length === 0) {
        console.log('Nothing to save — all clean');
        return;
      }

      console.group('Saving ' + dirty.length + ' dirty objects');
      dirty.forEach(function(obj) {
        var changes = obj.getChanges();
        console.log(obj.id + ':', changes);

        // Save to remote if storage configured
        if (store.storage) store.saveRemote(obj);

        // Mark clean
        obj._snapshot = JSON.parse(JSON.stringify(obj.data));
      });
      console.groupEnd();

      updateCounts();
      if (selected) renderPanel();
    }

    // ═══════════════════════════════════════════════════════════════
    // ARRANGE — simulates external changes via applyRemote
    // ═══════════════════════════════════════════════════════════════

    function arrangeAll() {
      var dialogs = store.find({class_id: 'ui-dialog'});
      if (dialogs.length === 0) {
        console.log('Nothing to arrange');
        return;
      }

      var changes = [];
      var xOffset = 20;

      // Line up dialogs side by side
      dialogs.forEach(function(dlg, i) {
        changes.push({
          id: dlg.id, class_id: 'ui-dialog',
          x: xOffset + i * 320, y: 20,
          width: 300, height: 200
        });

        // Stack buttons inside each dialog
        if (Array.isArray(dlg.data.children)) {
          dlg.data.children.forEach(function(btnId, j) {
            changes.push({
              id: btnId, class_id: 'ui-button',
              x: 10, y: 10 + j * 46,
              width: 120, height: 36
            });
          });
        }
      });

      // Also arrange free-standing buttons
      var freeButtons = store.find({class_id: 'ui-button'}).filter(function(btn) {
        return !findParentDialog(btn.id);
      });
      freeButtons.forEach(function(btn, i) {
        changes.push({
          id: btn.id, class_id: 'ui-button',
          x: 20 + dialogs.length * 320 + 20,
          y: 20 + i * 46,
          width: 120, height: 36
        });
      });

      // Apply as external changes — data + snapshot + DOM all update
      console.group('Arrange: applying ' + changes.length + ' external changes');
      changes.forEach(function(c) {
        var obj = store.applyRemote(c);
        updateContent(obj);
        console.log(c.id + ' → x:' + c.x + ' y:' + c.y);
      });
      console.groupEnd();

      updateCounts();
      if (selected) renderPanel();
    }

    // ═══════════════════════════════════════════════════════════════
    // SELECTION
    // ═══════════════════════════════════════════════════════════════

    function selectObj(obj) {
      if (selected && selected.el) selected.el.classList.remove('selected');
      selected = obj || null;
      if (selected && selected.el) selected.el.classList.add('selected');
      renderPanel();
    }

    workspaceEl.addEventListener('mousedown', function(e) {
      if (e.target === this || e.target.id === 'hint') selectObj(null);
    });

    // ═══════════════════════════════════════════════════════════════
    // DRAG & DROP
    // ═══════════════════════════════════════════════════════════════

    function startDrag(e, atom, canDrop) {
      if (!atom || !atom.el) return;

      var startX = e.clientX;
      var startY = e.clientY;
      var origX = atom.data.x;
      var origY = atom.data.y;

      function onMove(e2) {
        atom.data.x = origX + (e2.clientX - startX);
        atom.data.y = origY + (e2.clientY - startY);
        atom.syncToDom();
        if (selected === atom) updatePanelValues();
      }

      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (canDrop && atom.data.class_id === 'ui-button') {
          tryDropOnDialog(atom);
        }
        updateCounts();  // dirty count may have changed
      }

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }

    function tryDropOnDialog(btnAtom) {
      var btnEl = btnAtom.el;
      var btnRect = btnEl.getBoundingClientRect();
      var btnCx = btnRect.left + btnRect.width / 2;
      var btnCy = btnRect.top + btnRect.height / 2;

      var currentParent = btnEl.parentNode;
      var isNested = currentParent.classList && currentParent.classList.contains('dialog-body');

      // Find dialog under button center
      var targetDialog = null;
      var dialogs = store.find({class_id: 'ui-dialog'});
      for (var i = 0; i < dialogs.length; i++) {
        var dlg = dialogs[i];
        if (!dlg.el) continue;
        var r = dlg.el.getBoundingClientRect();
        if (btnCx >= r.left && btnCx <= r.right && btnCy >= r.top && btnCy <= r.bottom) {
          targetDialog = dlg;
          break;
        }
      }

      if (targetDialog) {
        var dlgBody = targetDialog.el.querySelector('.dialog-body');
        var dlgRect = dlgBody.getBoundingClientRect();

        if (isNested && currentParent === dlgBody) return;
        if (isNested) unnestButton(btnAtom);

        // Convert to relative coords
        var wsRect = workspaceEl.getBoundingClientRect();
        btnAtom.data.x = Math.max(0, btnAtom.data.x - (dlgRect.left - wsRect.left));
        btnAtom.data.y = Math.max(0, btnAtom.data.y - (dlgRect.top - wsRect.top));
        btnAtom.syncToDom();

        // Add to dialog children
        if (!Array.isArray(targetDialog.data.children)) targetDialog.data.children = [];
        if (targetDialog.data.children.indexOf(btnAtom.id) === -1) {
          targetDialog.data.children.push(btnAtom.id);
        }

        btnEl.classList.add('nested');
        dlgBody.appendChild(btnEl);
        if (selected) updatePanelValues();
        console.log(targetDialog.id + '.children =', targetDialog.data.children);

      } else if (isNested) {
        var wsRect = workspaceEl.getBoundingClientRect();
        var absX = btnRect.left - wsRect.left;
        var absY = btnRect.top - wsRect.top;
        unnestButton(btnAtom);
        btnAtom.data.x = absX;
        btnAtom.data.y = absY;
        btnAtom.syncToDom();
        workspaceEl.appendChild(btnEl);
        btnEl.classList.remove('nested');
        if (selected) updatePanelValues();
      }
    }

    function unnestButton(btnAtom) {
      var dialogs = store.find({class_id: 'ui-dialog'});
      for (var i = 0; i < dialogs.length; i++) {
        var dlg = dialogs[i];
        if (Array.isArray(dlg.data.children)) {
          var idx = dlg.data.children.indexOf(btnAtom.id);
          if (idx >= 0) {
            dlg.data.children.splice(idx, 1);
            break;
          }
        }
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // PROPERTIES PANEL
    // ═══════════════════════════════════════════════════════════════

    function renderPanel() {
      var container = document.getElementById('panel-content');
      if (!selected) {
        container.innerHTML = '<div class="panel-empty">Select an element</div>';
        return;
      }
      var obj = selected;
      var isDirty = obj.hasChanges();
      var html = '';

      // Identity
      html += '<div class="panel-section"><h3>Identity</h3>';
      html += propRowReadonly('id', obj.id);
      html += propRowReadonly('class', obj.class_id);
      var classObj = store.objects[obj.class_id];
      if (classObj && classObj.data.extends_id) {
        html += propRowReadonly('extends', classObj.data.extends_id);
      }
      html += propRowReadonly('type', obj.constructor.name);
      html += propRowReadonly('dirty', isDirty ? 'yes' : 'no', isDirty);
      html += '</div>';

      // Properties
      html += '<div class="panel-section"><h3>Properties</h3>';
      var props = store.collectClassProps(obj.class_id);
      props.forEach(function(propDef) {
        var dotIdx = propDef.id.lastIndexOf('.');
        var key = dotIdx >= 0 ? propDef.id.substring(dotIdx + 1) : propDef.id;
        if (key === 'children') {
          var ids = obj.data.children || [];
          html += propRowReadonly('children', ids.length > 0 ? ids.join(', ') : '(none)');
        } else {
          var val = obj.data[key];
          if (val === undefined || val === null) val = '';
          html += propRowEditable(key, val, propDef.data_type || 'string');
        }
      });
      html += '</div>';

      // Raw data
      html += '<div class="panel-section"><h3>Raw Data</h3>';
      html += '<pre style="font-size:11px;color:#8899aa;white-space:pre-wrap;word-break:break-all">' +
        escHtml(JSON.stringify(obj.data, null, 2)) + '</pre>';
      html += '</div>';

      container.innerHTML = html;

      // Bind inputs → model → DOM
      container.querySelectorAll('.prop-value').forEach(function(input) {
        input.addEventListener('change', function() {
          var key = this.dataset.key;
          var type = this.dataset.type;
          var val = this.value;
          if (type === 'float' || type === 'integer') val = parseFloat(val) || 0;
          obj.data[key] = val;
          obj.syncToDom();
          updateContent(obj);
          updateRawDisplay();
          updateCounts();
        });
      });
    }

    function propRowReadonly(label, value, highlight) {
      var cls = highlight ? 'prop-readonly prop-dirty' : 'prop-readonly';
      return '<div class="prop-row"><span class="prop-label">' + label +
        '</span><span class="' + cls + '">' + escHtml(String(value)) + '</span></div>';
    }

    function propRowEditable(key, value, type) {
      var inputType = (type === 'float' || type === 'integer') ? 'number' : 'text';
      var step = type === 'float' ? 'any' : '1';
      return '<div class="prop-row"><span class="prop-label">' + key +
        '</span><input class="prop-value" type="' + inputType + '" step="' + step +
        '" data-key="' + key + '" data-type="' + type +
        '" value="' + escHtml(String(value)) + '"></div>';
    }

    function updatePanelValues() {
      if (!selected) return;
      var container = document.getElementById('panel-content');
      container.querySelectorAll('.prop-value').forEach(function(input) {
        var key = input.dataset.key;
        var val = selected.data[key];
        if (val === undefined || val === null) val = '';
        if (document.activeElement !== input) input.value = val;
      });
      updateRawDisplay();
    }

    function updateRawDisplay() {
      if (!selected) return;
      var pre = document.querySelector('#panel-content pre');
      if (pre) pre.textContent = JSON.stringify(selected.data, null, 2);
    }

    // ═══════════════════════════════════════════════════════════════
    // STATUS BAR — counts + dirty indicator
    // ═══════════════════════════════════════════════════════════════

    function updateCounts() {
      var dialogs = store.find({class_id: 'ui-dialog'});
      var buttons = store.find({class_id: 'ui-button'});
      document.getElementById('obj-count').textContent = dialogs.length + buttons.length;
      document.getElementById('dialog-count').textContent = dialogs.length;
      document.getElementById('button-count').textContent = buttons.length;

      // Count dirty objects (workspace + all UI elements)
      var dirtyCount = 0;
      if (ws && ws.hasChanges()) dirtyCount++;
      dialogs.concat(buttons).forEach(function(obj) {
        if (obj.hasChanges()) dirtyCount++;
      });
      document.getElementById('dirty-count').textContent = dirtyCount;
    }

    // ═══════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════

    initWorkspace();

    console.log('Classes:', store.find({class_id: '@class'}).map(function(c) { return c.id; }));
    console.log('Factory: new AtomObj({class_id:"ui-button"}, store) instanceof AtomElement →',
      new AtomObj({class_id: 'ui-button'}, store) instanceof AtomElement);
    console.log('Workspace:', ws.id, '| children:', ws.data.children);
    console.log('');
    console.log('Try:');
    console.log('  store.find({class_id: "ui-dialog"})');
    console.log('  store.applyRemote({id: "dlg-1", x: 50, y: 50, title: "Remote!"})');
    console.log('  store.saveDirty()');
    updateCounts();
  </script>
</body>
</html>
